# Object/Relational Mapping and Entity Framework

An Object/Relational Mapper (ORM) is a software tool for automatically connecting C# objects to relational database tables. You've likely noticed that when working with ADO<span>.NET</span> you have to write a lot of SQL and C# code that is largely repetitive. An ORM is a tool that does the repetitive SQL and boilerplate C# for you. An ORM greatly reduces - often eliminates - the need to write SQL in your application.

## Entity Framework

Entity Framework (EF) is a popular ORM created by Microsoft. It allows you to use LINQ methods in conjunction with your data models to interact with your database (e.g. SELECT. INSERT, UPDATE, DELETE data). EF then determines the SQL syntax needed to perform the appropriate action(s).

Here's an example showing the different between EF and ADO<span>.NET</span>. This example selects all of the departments from the Bangazon database.

## Select all Departments

### ADO<span>.NET</span> Example

```cs
public ActionResult Index()
{
    using (SqlConnection conn = Connection)
    {
        conn.Open();
        using (SqlCommand cmd = conn.CreateCommand())
        {
            cmd.CommandText = "SELECT Id, Name, Budget FROM Department";
            SqlDataReader reader = cmd.ExecuteReader();

            List<Department> departments = new List<Department>();
            while (reader.Read())
            {
                departments.Add(new Department
                {
                    Id = reader.GetInt32(reader.GetOrdinal("Id")),
                    Name = reader.GetString(reader.GetOrdinal("name")),
                    Budget = reader.GetInt32(reader.GetOrdinal("budget"))
                });
            }
            reader.Close();
            return View(departments);
        }
    }
}

```

### EF Example

```cs
public async Task<IActionResult> Index()
{
    return View(await _context.Department.ToListAsync());
}
```

## Create New Department

You also create new database entries with other methods that abstract the SQL away from you - the `Add()` and `SaveChangesAsync()` methods.

### ADO<span>.NET</span> Example

```cs
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult Create(Department department)
{
    using (SqlConnection conn = Connection)
    {
        conn.Open();
        using (SqlCommand cmd = conn.CreateCommand())
        {
            cmd.CommandText = @"INSERT INTO Department ([name], budget)
                                     VALUES (@name, @budget)";
            cmd.Parameters.Add(new SqlParameter("@name", department.Name));
            cmd.Parameters.Add(new SqlParameter("@budget", department.Budget));

            cmd.ExecuteReader();

            return RedirectToAction(nameof(Index));
        }
    }
}
```

### EF Example

```cs
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Create(Department department)
{
    if (ModelState.IsValid)
    {
        _context.Add(department);
        await _context.SaveChangesAsync();
        return RedirectToAction(nameof(Index));
    }
    return View(department);
}
```

## References

### Startup.cs

To enable EF model-first migrations, this is what your `ConfigureServices` method should be in the `Startup.cs` file.

```cs
public void ConfigureServices (IServiceCollection services) {
    services.Configure<CookiePolicyOptions> (options => {
        // This lambda determines whether user consent for non-essential cookies is needed for a given request.
        options.CheckConsentNeeded = context => true;
        options.MinimumSameSitePolicy = SameSiteMode.None;
    });

    services.AddDbContext<ApplicationDbContext> (options =>
        options.UseSqlServer (
            Configuration.GetConnectionString ("DefaultConnection")));

    services.AddMvc ().SetCompatibilityVersion (CompatibilityVersion.Version_2_2);
}
```

## The Cost of Convenience

While the simpler syntax may seem like a breath of fresh air, and much easier to read (_once you get used to it_), you pay for it with poorer performance. The SQL generated by EF is a sore spot by many developers because there are cases where it is not as fast and optimized as it would be if written out in long-form by the developer.

* [Dapper vs Entity Framework vs ADO.NET Performance Benchmarking](https://www.exceptionnotfound.net/dapper-vs-entity-framework-vs-ado-net-performance-benchmarking/)
* [Performance: Entity Framework 7 vs. Dapper.net vs. raw ADO.NET](https://ppanyukov.github.io/2015/05/20/entity-framework-7-performance.html)

> **NOTE:** [Dapper](https://github.com/StackExchange/Dapper) is a popular "light-weight" ORM. It's an alternative to EF and ADO<span>.NET</span>. We won't be discussing Dapper in this course.

## Tutorial

Please do the [ASP.NET Core MVC with Entity Framework Core - Tutorial](https://docs.microsoft.com/en-us/aspnet/core/data/ef-mvc/?view=aspnetcore-2.2) in which you will build a small web application using EF. It shows you how to configure your application for using it, how to set up a database context, and how to use that database context with LINQ statements to interact with a database.
